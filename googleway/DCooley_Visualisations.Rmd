---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(googleway)
library(sf)
```

## googleway

```{r visualisationGoogleway} 
set_key(read.dcf("~/Documents/.googleAPI", fields = "GOOGLE_MAP_KEY"), api = "map")
set_key(read.dcf("~/Documents/.googleAPI", fields = "GOOGLE_API_KEY"))
```

The `googleway` library provides access to Google Maps API, both for creating maps, and using the mapping services such as geocoding and searching for places. 

To use any of Google Map's services you will need an [API key](https://developers.google.com/maps/documentation/javascript/get-api-key).

## Geocoding

The geocoding API will take as input an address, or search term, and return various pieces of information

```{r, eval = FALSE}
rehab_addresses <- c(
  DandenongHospital = "Dandenong Hospital, Dandenong VIC 3175, Australia",
  CaseyHospital = "62-70 Kangan Dr, Berwick VIC 3806, Australia",
  KingstonHospital = "The Kingston Centre, Heatherton VIC 3202, Australia"
  )

RehabLocations <- lapply(rehab_addresses, googleway::google_geocode)
#saveRDS(RehabLocations, file = "../data/googleway/RehabLocations_googleway.rds")
```

For example, the type of location and coordinates 

```{r}
RehabLocations <- readRDS("./data/googleway/RehabLocations_googleway.rds")
RehabLocations[[1]][["results"]][["address_components"]]
RehabLocations[[1]][["results"]][["geometry"]][["location"]]
```

```{r}

RehabLocations <- lapply( RehabLocations, function(x) {
  coords <- googleway::geocode_coordinates(x)
  data.frame(
    formatted_address = googleway::geocode_address(x),
    lat = coords[["lat"]],
    lon = coords[["lng"]]
    )
})

RehabLocations <- do.call(rbind, RehabLocations)

```

Which can be converted into an `sf` object

```{r}
# 
# RehabLocations <- sf::st_as_sf(
#   RehabLocations, 
#   coords = c("lon","lat"),
#   crs = sf::st_crs(basicDemographicsVIC)
#   )
# 
# RehabLocations
```


## TODO

- google_directions() on each of the random addresses to each of the rehab centres



## Addresses to Rehab

```{r}

## need coordinates for googleway
df <- as.data.frame( randomaddresses )
df[, c("lon", "lat")] <- sf::st_coordinates( randomaddresses )

head( df )

s <- sample(1:nrow(df), size = 20)

## The directions API has a limit of ..
res <- lapply( s, function(x) { 
  googleway::google_directions(
    origin = as.numeric( df[x, c("lat", "lon")] )
    , destination = as.numeric( sf::st_coordinates( RehabLocations[1, "geometry"] )[, c("Y","X")] )
  )
})
# s
# [1] 55966 42386  9474 52623 32448 46598 43243 37036  5550 14648 52575 15485 25992 22176 17796 53280 26391
# [18] 23724  3772 34709

df_directions <- data.frame( polyline = sapply(res, googleway::direction_polyline) )

google_map() %>%
  add_polylines(
    data = df_directions
    , polyline = "polyline"
  )

```