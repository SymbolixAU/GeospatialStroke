---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(googleway)
library(sf)
```

## googleway

```{r visualisationGoogleway} 
set_key(read.dcf("~/Documents/.googleAPI", fields = "GOOGLE_MAP_KEY"), api = "map")
set_key(read.dcf("~/Documents/.googleAPI", fields = "GOOGLE_API_KEY"))
```

The `googleway` library provides access to Google Maps API, both for creating maps, and using the mapping services such as geocoding, direction and route finding, and searching for places. 

To use any of Google Map's services you will need an [API key](https://developers.google.com/maps/documentation/javascript/get-api-key).

## Geocoding

The geocoding API will take as input an address, or search term, and return various pieces of information. For example, here we are querying the API for three rehab centre addresses.

```{r, eval = FALSE}
rehab_addresses <- c(
  DandenongHospital = "Dandenong Hospital, Dandenong VIC 3175, Australia",
  CaseyHospital = "62-70 Kangan Dr, Berwick VIC 3806, Australia",
  KingstonHospital = "The Kingston Centre, Heatherton VIC 3202, Australia"
  )

RehabLocations <- lapply(rehab_addresses, googleway::google_geocode)
#saveRDS(RehabLocations, file = "../data/googleway/RehabLocations_googleway.rds")
```

```{r, eval = TRUE, echo = FALSE}
RehabLocations <- readRDS("./data/googleway/RehabLocations_googleway.rds")
```

From the results we can extract various pieces of information, such as the formatted address, the type of place, and the coordinates.

```{r}
RehabLocations[[1]][["results"]][["formatted_address"]]
RehabLocations[[1]][["results"]][["address_components"]]
RehabLocations[[1]][["results"]][["geometry"]][["location"]]
```


## Directions



We have 56,000 random addresses, and 3 rehab centres. This makes `r 56000 * 3` direction queries. 

Google charges 0.005 USD per query, but gives you $200 credit each month.

Therefore, we get `r 200 / 0.005` queries credited per month. 

To stay within limits, and have enough spare, I'm going to sample 10,000 of those random addresses for each rehab centre, and query the API for the directions from those addresses to the rehab centres. 


```{r}

## formatting the geocoded rehab centres into a data.frame
lst <- lapply( RehabLocations, function(x) {
  coords <- googleway::geocode_coordinates(x)
  data.frame(
    formatted_address = googleway::geocode_address(x),
    lat = coords[["lat"]],
    lon = coords[["lng"]]
    )
})

df_rehab <- do.call(rbind, lst)
rm(lst)
#df_rehab
```


To find the directions we need to query one route at a time. We can do this in an `lapply`. 

As this takes a while we are saving the results of each query to file at each iteration. Each result is in JSON, so we are saving the raw JSON.

```{r, eval = FALSE, echo = TRUE, include = TRUE}

set.seed(12345)
r <- 1:nrow(df)
r1 <- sample(r, size = 10000)
r2 <- sample(r, size = 10000)
r3 <- sample(r, size = 10000)

res1 <- lapply(r1, function(x) {
  js <- googleway::google_directions(
    origin = as.numeric( df_rehab[x, c("lat", "lon")] )
    , destination = as.numeric( sf::st_coordinates( RehabLocations[1, "geometry"] )[, c("Y","X")] )
    , simplify = F
  )
  js <- paste0(js, collapse = "")
  js <- gsub(" ","",js)
  fn <- paste0("../data/googleway/directions_queries/rehab1/",x,"_results.json")
  f <- file(fn)
  writeLines(js, f)
  close(f)
  return( js )
})

res2 <- lapply(r2, function(x) {
  js <- googleway::google_directions(
    origin = as.numeric( df_rehab[x, c("lat", "lon")] )
    , destination = as.numeric( sf::st_coordinates( RehabLocations[2, "geometry"] )[, c("Y","X")] )
  )
  js <- paste0(js, collapse = "")
  js <- gsub(" ","",js)
  fn <- paste0("../data/googleway/directions_queries/rehab2/",x,"_results.json")
  f <- file(fn)
  writeLines(js, f)
  close(f)
  return( js )
})

res3 <- lapply(r3, function(x) {
  js <- googleway::google_directions(
    origin = as.numeric( df_rehab[x, c("lat", "lon")] )
    , destination = as.numeric( sf::st_coordinates( RehabLocations[3, "geometry"] )[, c("Y","X")] )
  )
    js <- paste0(js, collapse = "")
  js <- gsub(" ","",js)
  fn <- paste0("../data/googleway/directions_queries/rehab3/",x,"_results.json")
  f <- file(fn)
  writeLines(js, f)
  close(f)
  return( js )
})

```

Now we have all the results of the directions query saved we can read them back into the R session

```{r, echo = TRUE, include = FALSE, eval = FALSE}

get_directions <- function(rehab) {
  path <- "~/Documents/github/GeospatialStroke/data/googleway/directions_queries"
  lst_files <- list.files(path = paste0(path, "/rehab1/") )
  files <- paste0(path, "/rehab1/", lst_files)

  return(
    lapply( files, jsonlite::fromJSON )
  )
}

directions1 <- get_directions( "/rehab1/")
directions2 <- get_directions( "/rehab2/")
directions3 <- get_directions( "/rehab3/")
```

```{r echo = FALSE, include = FALSE, eval = FALSE}
saveRDS(directions1, file = "~/Documents/github/GeospatialStroke/data/googleway/directions/directions1.rds")
saveRDS(directions2, file = "~/Documents/github/GeospatialStroke/data/googleway/directions/directions2.rds")
saveRDS(directions3, file = "~/Documents/github/GeospatialStroke/data/googleway/directions/directions3.rds")

```

The route geometry returned from the API comes in the form of an [encoded polyline](https://developers.google.com/maps/documentation/utilities/polylinealgorithm).  

```{r}
substr( googleway::direction_polyline( directions1[[1]] ), 1, 100 )
```

We can convert this back into coordinates using the `googlePolylines` library, for example

```{r}
pl <- googleway::direction_polyline( directions1[[1]] )

head( googlePolylines::decode( pl )[[1]] )
```

However, `googleway` and `mapdeck` both support plotting these polylines directly, so we can avoid this step and just use the polylines. We can also get the distance and time on the routes. 

```{r}

get_distance <- function(x) {
  googleway::direction_legs(x)[["distance"]][["value"]]
}
get_duration <- function(x) {
  googleway::direction_legs(x)[["duration"]][["value"]]
}

format_directions <- function( directions ) {
  data.frame(
  polyline = sapply( directions, googleway::direction_polyline )
  , distance_m = sapply( directions, get_distance )
  , duration_s = sapply( directions, get_duration )
  )
}

df_directions1 <- format_directions( directions1 )
df_directions2 <- format_directions( directions2 )
df_directions3 <- format_directions( directions3 )

```

Now we have three data.frames, 

```{r}

library(mapdeck)

set_token( read.dcf("~/Documents/.googleAPI", fields = "MAPBOX" ) )

mapdeck(
  style = mapdeck_style("light")
  , location = c(145, -37.9)
  , zoom = 10
) %>%
  add_scatterplot(
    data = df_rehab[1, ]
    , lon = "lon", lat = "lat"
    , radius = 200
    , update_view = F
  ) %>%
  add_path(
    data = df_directions1[30:70, ]
    , polyline = "polyline"
    , stroke_colour = "duration_s"
    , stroke_opacity = 100
    , stroke_width = 35
    , legend = T
    , legend_options = list( title = "Duration (seconds) ")
    , update_view = F
  )

```

```{r}
# s
# [1] 55966 42386  9474 52623 32448 46598 43243 37036  5550 14648 52575 15485 25992 22176 17796 53280 26391
# [18] 23724  3772 34709

df_directions <- data.frame( polyline = sapply(res, googleway::direction_polyline) )

google_map() %>%
  add_polylines(
    data = df_directions
    , polyline = "polyline"
  )

```